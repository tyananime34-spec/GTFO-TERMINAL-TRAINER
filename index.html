<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>GTFO TERMINAL TRAINER - PRO</title>
    <style>
        :root {
            --bg: #01080e; --main: #00e5ff; --text: #ffffff;
            --dim: #162e3a; --err: #ff4d4d; --check-color: #607d8b;
            --success: #00ff88;
            --font: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }
        body {
            margin: 0; background: var(--bg); color: var(--text);
            font-family: var(--font); height: 100vh; overflow: hidden;
            display: flex; align-items: center; justify-content: center;
        }
        #terminal {
            width: 950px; padding: 45px; border: 1px solid rgba(0, 229, 255, 0.2);
            background: linear-gradient(145deg, rgba(2, 15, 25, 0.98), rgba(1, 8, 14, 0.99));
            position: relative; border-radius: 28px;
            box-shadow: 0 20px 80px rgba(0, 0, 0, 0.8), 0 0 40px rgba(0, 229, 255, 0.05);
        }
        
        /* Кнопки в углах */
        .ui-btn {
            position: absolute; top: 25px; font-size: 0.7rem; 
            cursor: pointer; border: 1px solid var(--dim); padding: 8px 18px; 
            color: #4a6a7a; border-radius: 40px; transition: 0.3s;
            font-weight: 800; text-transform: uppercase; letter-spacing: 1.5px;
            background: transparent;
        }
        #sound-btn { right: 35px; }
        #sound-btn.on { color: var(--main); border-color: var(--main); background: rgba(0, 229, 255, 0.05); }
        #exit-btn-top { left: 35px; color: #ff4d4d; border-color: rgba(255, 77, 77, 0.3); }
        #exit-btn-top:hover { background: rgba(255, 77, 77, 0.1); border-color: #ff4d4d; }

        .history-dots { display: flex; justify-content: center; gap: 12px; margin-bottom: 35px; }
        .dot { width: 35px; height: 8px; border: 1px solid var(--dim); border-radius: 10px; transition: 0.4s; background: rgba(255,255,255,0.05); }

        .stats {
            display: flex; justify-content: flex-start; align-items: center;
            padding-bottom: 15px; font-size: 0.85rem; color: var(--main);
            font-weight: 700; text-transform: uppercase; letter-spacing: 1px;
            border-bottom: 1px solid rgba(0, 229, 255, 0.1); margin-bottom: 20px;
        }

        .target-box {
            text-align: center; font-size: 1.9rem; letter-spacing: 1.5px;
            color: var(--text); margin-bottom: 25px; min-height: 2.2em;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-weight: 700;
        }
        .uplink-row { 
            font-size: 1.05rem; color: #7090a0; margin-top: 15px; font-weight: 600; 
            background: rgba(0,229,255,0.08); padding: 14px 28px; 
            border: 1px dashed var(--dim); border-radius: 16px; font-family: monospace;
        }

        .bar-info {
            display: flex; justify-content: space-between; align-items: flex-end;
            height: 1.8rem; margin-bottom: 5px; padding: 0 2px;
        }
        #status-msg { font-weight: 800; font-size: 1.2rem; text-transform: uppercase; letter-spacing: 2px; }
        #timer-display { font-family: monospace; font-size: 1.4rem; color: var(--main); font-weight: 700; }

        .timer-bg { width: 100%; height: 8px; background: rgba(0,0,0,0.5); margin-bottom: 10px; border-radius: 10px; overflow: hidden; }
        #timer-bar { height: 100%; width: 100%; background: var(--main); box-shadow: 0 0 20px rgba(0, 229, 255, 0.5); }
        
        #timer-bar.checking { background: var(--check-color); transition: width 0.8s linear; box-shadow: none; }
        #timer-bar.success { background: var(--success); box-shadow: 0 0 20px var(--success); }
        #timer-bar.error { background: var(--err); box-shadow: 0 0 20px var(--err); }

        .desc-box { min-height: 60px; margin-bottom: 25px; text-align: center; color: #a0c0d0; font-size: 1.15rem; font-weight: 500; }
        
        .input-line {
            position: relative; font-size: 2.3rem; display: flex; align-items: center;
            border-left: 6px solid var(--main); padding-left: 25px; 
            background: rgba(0,229,255,0.04); border-radius: 8px 20px 20px 8px;
        }
        #highlight-layer { position: absolute; left: 25px; top: 0; pointer-events: none; white-space: pre; color: transparent; z-index: 3; font-weight: 700; }
        .char-err { color: var(--err); text-decoration: underline; }

        #input {
            background: transparent; border: none; outline: none;
            color: var(--text); font-family: var(--font); font-size: 2.3rem;
            width: 100%; text-transform: uppercase; z-index: 2; font-weight: 700;
        }
        .main-title { font-size: 3rem; font-weight: 900; letter-spacing: -1px; color: var(--main); margin-bottom: 30px; text-align: center; text-transform: uppercase; }
        .menu-section { margin-bottom: 25px; text-align: center; }
        .menu-label { font-size: 0.75rem; color: #5a7a8a; letter-spacing: 4px; margin-bottom: 15px; font-weight: 800; text-transform: uppercase; }
        
        .opt-group { display: flex; justify-content: center; gap: 10px; }
        .opt { 
            padding: 12px 24px; cursor: pointer; border: 1px solid var(--dim); 
            color: #608090; font-weight: 700; font-size: 0.85rem; border-radius: 40px;
            transition: 0.3s; min-width: 140px; text-transform: uppercase;
        }
        .opt.active { border-color: var(--main); background: rgba(0, 229, 255, 0.1); color: var(--text); }
        .opt.special.active { border-color: #ff9800; color: #ff9800; background: rgba(255, 152, 0, 0.1); }
        .opt.danger.active { border-color: var(--err); color: var(--err); background: rgba(255, 77, 77, 0.1); }
        
        .start-btn { 
            margin-top: 10px; padding: 20px 100px; border: none; 
            cursor: pointer; font-weight: 900; letter-spacing: 5px; border-radius: 20px;
            background: var(--main); color: var(--bg); transition: 0.4s;
            text-transform: uppercase; font-size: 1.1rem;
        }
        .start-btn:hover { transform: scale(1.05); }
        
        .hidden { display: none !important; }
        .blink { animation: blinker 1.5s linear infinite; color: var(--main); font-weight: 800; }
        @keyframes blinker { 50% { opacity: 0.2; } }
    </style>
</head>
<body>

<div id="terminal">
    <div id="sound-btn" class="ui-btn on" onclick="toggleSound()">Звук: ВКЛ</div>
    <div id="exit-btn-top" class="ui-btn hidden" onclick="location.reload()">Выйти</div>

    <div id="m-screen">
        <div class="main-title">GTFO TERMINAL TRAINER</div>
        
        <div class="menu-section">
            <div class="menu-label">Сложность</div>
            <div class="opt-group">
                <div class="opt" onclick="setDiff('EASY', this)">Легко</div>
                <div class="opt active" onclick="setDiff('NORM', this)">Нормально</div>
                <div class="opt" onclick="setDiff('HARD', this)">Сложно</div>
            </div>
        </div>

        <div class="menu-section">
            <div class="menu-label">Режим</div>
            <div class="opt-group">
                <div class="opt active" onclick="setMode('REG', this)">Обычный</div>
                <div class="opt" onclick="setMode('ZEN', this)">Без времени</div>
            </div>
        </div>

        <div class="menu-section">
            <div class="menu-label">Настройки помощи</div>
            <div class="opt-group">
                <div id="hint-toggle" class="opt active special" onclick="toggleHighlight(this)">Подсветка ошибок: ВКЛ</div>
            </div>
        </div>

        <div class="menu-section">
            <div class="menu-label">Экспертные функции</div>
            <div class="opt-group">
                <div id="hardcore-toggle" class="opt danger" onclick="toggleHardcore(this)">РЕЖИМ HARDCORE: ВЫКЛ</div>
            </div>
        </div>

        <div style="text-align:center">
            <button class="start-btn" onclick="gameStart()">НАЧАТЬ</button>
        </div>
    </div>

    <div id="g-screen" class="hidden">
        <div class="history-dots" id="dots-panel"></div>
        <div class="stats">
            <div>СРЕДНЯЯ СКОРОСТЬ: <span id="avg-time">0.0</span> сек</div>
        </div>
        
        <div id="target-cmd" class="target-box">
            <div id="cmd-text"></div>
            <div id="uplink-data" class="uplink-row hidden"></div>
        </div>

        <div class="bar-info">
            <div id="status-msg"></div> 
            <div id="timer-display"><span id="cur-timer">0.0</span></div>
        </div>
        
        <div class="timer-bg"><div id="timer-bar"></div></div>
        <div class="desc-box" id="desc-text"></div>
        <div class="input-line">
            <div id="highlight-layer"></div>
            <input type="text" id="input" autocomplete="off" spellcheck="false">
        </div>
        <div style="text-align:center; margin-top:20px; height:20px">
            <div id="enter-hint" class="blink hidden">НАЖМИТЕ [ENTER] ДЛЯ ПРОДОЛЖЕНИЯ</div>
        </div>
    </div>
</div>

<script>
let soundEnabled = true;
let audioCtx = null;

const WORDS = ["VOID", "CORE", "RISK", "DATA", "FLOW", "SYNC", "LINK", "GRID", "NODE", "BASE", "ZULU", "DARK", "BEAM", "CELL", "BONE", "DISK", "PLUG", "GATE", "ZONE", "FAST", "DEBT", "SOUL", "GRIT", "WOLF", "ZERO", "PATH", "MIND", "SCAN", "WORK", "HELL", "DUST", "ROCK", "SHIP", "SALT", "WIND", "GOLD", "IRON", "STAY", "KILL", "LIFE", "HOPE", "RARE", "DROP", "MIST", "COAL", "GEAR", "FUEL", "TANK", "PIPE", "WIRE", "BOLT", "JUMP", "LIFT", "STOP", "LOAD", "SAVE", "EXIT", "BLUE", "FIRE", "BOMB"];
const QUEST_OBJS = ["CELL", "TURBINE", "CARGO", "HSU", "NEONATE_HSU", "GENERATOR", "TERMINAL", "DISINFECT_STATION"];
const RESOURCES = ["AMMOPACK", "MEDIPACK", "TOOL_REFILL", "DISINFECT_PACK"];
const COMMANDS = ["LIST", "QUERY", "PING", "LOGS", "READ", "REACTOR_STARTUP", "REACTOR_SHUTDOWN", "REACTOR_VERIFY", "UPLINK_CONNECT", "UPLINK_VERIFY"];

const TIMERS = {
    EASY: { LIST:30, QUERY:30, PING:30, LOGS:10, READ:30, REACTOR_STARTUP:20, REACTOR_SHUTDOWN:20, REACTOR_VERIFY:30, UPLINK_CONNECT:30, UPLINK_VERIFY:40 },
    NORM: { LIST:15, QUERY:15, PING:15, LOGS:5,  READ:15, REACTOR_STARTUP:15, REACTOR_SHUTDOWN:15, REACTOR_VERIFY:20, UPLINK_CONNECT:20, UPLINK_VERIFY:25 },
    HARD: { LIST:10, QUERY:10, PING:10, LOGS:5,  READ:10, REACTOR_STARTUP:10, REACTOR_SHUTDOWN:10, REACTOR_VERIFY:10, UPLINK_CONNECT:10, UPLINK_VERIFY:15 }
};

const LIST_LABELS = { "A":'все объекты и ресурсы', "W":'квестовые объекты', "U":'квестовые объекты и ресурсы', "RE":'ресурсы', "Y":'ключи', "ID":'персональные идентификаторы', "CELL":'батареи' };

let state = { 
    diff: 'NORM', 
    mode: 'REG', 
    hardcore: false, 
    showHints: true, 
    qIndex: 0, phase: 'MENU', totalTime: 0, count: 0, errors: 0, history: [], taskBag: [], activeTask: null, timer: null, startTime: 0 
};

function playSound(freq, type, duration, vol) {
    if (!soundEnabled) return;
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
    osc.type = type; osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
    gain.gain.setValueAtTime(vol, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
    osc.connect(gain); gain.connect(audioCtx.destination);
    osc.start(); osc.stop(audioCtx.currentTime + duration);
}

function toggleSound() {
    soundEnabled = !soundEnabled;
    document.getElementById('sound-btn').innerText = `Звук: ${soundEnabled ? 'ВКЛ' : 'ВЫКЛ'}`;
    document.getElementById('sound-btn').classList.toggle('on', soundEnabled);
}

function setDiff(d, el) { state.diff = d; el.parentNode.querySelectorAll('.opt').forEach(b => b.classList.remove('active')); el.classList.add('active'); }
function setMode(m, el) { state.mode = m; el.parentNode.querySelectorAll('.opt').forEach(b => b.classList.remove('active')); el.classList.add('active'); }
function toggleHardcore(el) { state.hardcore = !state.hardcore; el.classList.toggle('active', state.hardcore); el.innerText = `РЕЖИМ HARDCORE: ${state.hardcore ? 'ВКЛ' : 'ВЫКЛ'}`; }
function toggleHighlight(el) { state.showHints = !state.showHints; el.classList.toggle('active', state.showHints); el.innerText = `Подсветка ошибок: ${state.showHints ? 'ВКЛ' : 'ВЫКЛ'}`; }

function rand(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }
function genFileName() {
    const s = () => Math.random().toString(36).substring(2,5).toUpperCase();
    return Math.random() > 0.5 ? `${s()}-${s()}-${s()}` : `REACTOR_VER${["X","Y","Z"][rand(0,2)]}${rand(1,9).toString().padStart(2,'0')}.LOG`;
}

function generateTask() {
    if (state.taskBag.length === 0) state.taskBag = [0,1,2,3,4,5,6,7,8,9,10,11,12,13,14].sort(() => Math.random() - 0.5);
    const id = state.taskBag.pop();
    let cmd = "", displayCmd = "", alts = [], desc = "", uplinkStr = "", tKey = "";
    
    const zNum = rand(1, 999); const zStr = `ZONE_${zNum}`;
    const word = WORDS[rand(0, WORDS.length-1)];
    const qObj = `${QUEST_OBJS[rand(0, QUEST_OBJS.length-1)]}_${rand(1, 999)}`;
    const rObj = `${RESOURCES[rand(0, RESOURCES.length-1)]}_${rand(1, 999)}`;
    const useZone = Math.random() > 0.5;

    switch(id) {
        case 0: case 4: case 6: case 7: case 8: case 9: 
            tKey = "LIST"; const filters = ["RE", "A", "Y", "W", "CELL", "ID", "U"];
            const f = filters[rand(0, filters.length - 1)]; const label = LIST_LABELS[f];
            cmd = useZone ? `LIST ${f} ${zStr}` : `LIST ${f}`;
            desc = useZone ? `Узнать ${label} находящиеся в зоне ${zStr}` : `Узнать ${label} находящиеся на уровне`;
            if (useZone) alts = [cmd, cmd.replace("ZONE_", "")];
            displayCmd = cmd; break;
        case 1: 
            tKey="QUERY"; cmd=`QUERY ${qObj}`; desc=useZone?`Запросить местоположения ${qObj} в ${zStr}`:`Запросить местоположения ${qObj} на уровне`; 
            if(useZone) { cmd += ` ${zStr}`; alts = [cmd, cmd.replace("ZONE_", "")]; }
            displayCmd = cmd; break;
        case 2: tKey="PING"; const pObj = Math.random()>0.5?qObj:rObj; cmd=`PING ${pObj}`; desc=`Отметить местоположение ${pObj}`; if(Math.random() < 0.5) { cmd += " -T"; desc += " (зациклить команду)"; } displayCmd = cmd; break;
        case 3: tKey="READ"; const fn = genFileName(); cmd=`READ ${fn}`; desc=`Прочитать файл ${fn}`; displayCmd = cmd; break;
        case 5: tKey="UPLINK_VERIFY"; 
                const tCode = ["X","Y","Z"][rand(0,2)]+rand(1,9).toString().padStart(2,'0'); 
                let pairs = []; for(let i=0;i<6;i++){ const c = (i===0)?tCode:["X","Y","Z"][rand(0,2)]+rand(1,9).toString().padStart(2,'0'); pairs.push(`${c}:${WORDS[rand(0,WORDS.length-1)]}`); }
                pairs.sort(()=>Math.random()-0.5); uplinkStr=pairs.join("   "); const corW=pairs.find(p=>p.startsWith(tCode)).split(":")[1];
                cmd=`UPLINK_VERIFY ${corW}`; desc=`Подтверждение создания подключения (Код: ${tCode})`; displayCmd = `UPLINK_VERIFY [PASSWORD]`; alts=[cmd]; break;
        case 10: tKey="REACTOR_VERIFY"; cmd=`REACTOR_VERIFY ${word}`; desc=`Подтверждение запуска реактора: ${word}`; displayCmd = cmd; break;
        case 11: tKey="UPLINK_CONNECT"; const ip=`${rand(10,255)}.${rand(0,255)}.${rand(0,255)}.${rand(1,254)}`; cmd=`UPLINK_CONNECT ${ip}`; desc=`Создать подключение с ${ip}`; displayCmd = cmd; break;
        case 12: tKey="LOGS"; cmd=`LOGS`; desc=`Вывести логи находящиеся в терминале`; displayCmd = cmd; break;
        case 13: tKey="REACTOR_STARTUP"; cmd=`REACTOR_STARTUP`; desc=`Инициализация последовательности запуска реактора`; displayCmd = cmd; break;
        case 14: tKey="REACTOR_SHUTDOWN"; cmd=`REACTOR_SHUTDOWN`; desc=`Инициализация последовательности выключения реактора`; displayCmd = cmd; break;
    }
    
    if(alts.length === 0) alts = [cmd];
    // Если Hardcore - используем время HARD и скрываем текст
    const finalTime = state.hardcore ? TIMERS['HARD'][tKey] : TIMERS[state.diff][tKey];
    return { cmd, displayCmd, alts, desc, uplink: uplinkStr, time: finalTime };
}

function updateUI() {
    document.getElementById('avg-time').innerText = state.count > 0 ? (state.totalTime/state.count).toFixed(1) : "0.0";
    const panel = document.getElementById('dots-panel'); panel.innerHTML = '';
    for(let i=0; i<10; i++) {
        const d = document.createElement('div'); d.className = 'dot';
        if(state.history[i] !== undefined) {
            d.style.backgroundColor = state.history[i] ? 'var(--success)' : 'var(--err)';
            d.style.boxShadow = `0 0 10px ${state.history[i] ? 'var(--success)' : 'var(--err)'}`;
        }
        panel.appendChild(d);
    }
}

function gameStart() {
    state.qIndex = 0; state.history = []; state.totalTime = 0; state.count = 0; state.errors = 0;
    document.getElementById('m-screen').classList.add('hidden');
    document.getElementById('g-screen').classList.remove('hidden');
    document.getElementById('exit-btn-top').classList.remove('hidden');
    updateUI(); nextTask();
}

function nextTask() {
    if (state.qIndex >= 10) { finishSession(); return; }
    state.phase = 'INPUT'; state.activeTask = generateTask(); state.startTime = Date.now();
    
    // В хардкоре команда всегда скрыта
    document.getElementById('cmd-text').innerText = (state.hardcore) ? "[ДАННЫЕ ЗАШИФРОВАНЫ]" : state.activeTask.displayCmd;
    document.getElementById('desc-text').innerText = state.activeTask.desc;
    
    const upBox = document.getElementById('uplink-data');
    if(state.activeTask.uplink) { upBox.innerText = state.activeTask.uplink; upBox.classList.remove('hidden'); }
    else { upBox.classList.add('hidden'); }
    
    document.getElementById('status-msg').innerText = ""; document.getElementById('enter-hint').classList.add('hidden');
    document.getElementById('timer-bar').className = ''; document.getElementById('timer-bar').style.width = '100%';
    document.getElementById('input').value = ''; document.getElementById('input').disabled = false; document.getElementById('input').focus();
    document.getElementById('highlight-layer').innerHTML = '';
    
    if(state.mode !== 'ZEN') startTimer(state.activeTask.time);
    else document.getElementById('cur-timer').innerText = "---";
}

function startTimer(sec) {
    clearInterval(state.timer); let cur = sec;
    state.timer = setInterval(() => {
        if(state.phase !== 'INPUT') return;
        cur -= 0.05; document.getElementById('cur-timer').innerText = Math.max(0, cur).toFixed(1);
        document.getElementById('timer-bar').style.width = (cur/sec*100) + '%';
        if(cur <= 0) { 
            clearInterval(state.timer); state.phase = 'TIMEOUT';
            document.getElementById('input').disabled = true;
            document.getElementById('status-msg').innerText = "ВРЕМЯ ВЫШЛО"; document.getElementById('status-msg').style.color = "var(--err)";
            document.getElementById('enter-hint').classList.remove('hidden');
            state.history.push(false); state.errors++; updateUI(); state.qIndex++;
            playSound(150, 'sawtooth', 0.4, 0.1);
        }
    }, 50);
}

function checkResult(val) {
    const spentTime = (Date.now() - state.startTime) / 1000;
    state.phase = 'CHECKING'; clearInterval(state.timer);
    document.getElementById('input').disabled = true;
    document.getElementById('cur-timer').innerText = spentTime.toFixed(1) + " сек";
    const bar = document.getElementById('timer-bar'); const statusBox = document.getElementById('status-msg');
    statusBox.innerText = "ПРОВЕРКА..."; statusBox.style.color = "var(--check-color)"; bar.style.width = '0%';
    
    setTimeout(() => {
        bar.className = 'checking'; bar.style.width = '100%';
        setTimeout(() => {
            state.phase = 'RESULT';
            const isOk = state.activeTask.alts.includes(val.trim().toUpperCase());
            if(isOk) {
                state.count++; state.totalTime += spentTime; state.history.push(true);
                statusBox.innerText = "УСПЕХ"; statusBox.style.color = "var(--success)"; bar.className = 'success'; playSound(880, 'sine', 0.1, 0.1);
            } else {
                state.errors++; state.history.push(false);
                statusBox.innerText = "ОШИБКА"; statusBox.style.color = "var(--err)";
                bar.className = 'error'; playSound(150, 'sawtooth', 0.3, 0.1); showDiff(val);
            }
            updateUI(); state.qIndex++; document.getElementById('enter-hint').classList.remove('hidden');
        }, 800);
    }, 50);
}

function showDiff(val) {
    const tgt = state.activeTask.alts[0]; let h = "";
    for(let i=0; i<Math.max(tgt.length, val.length); i++) {
        if(i < val.length) h += (i < tgt.length && val[i].toUpperCase() === tgt[i]) ? `<span style="color:transparent">${val[i]}</span>` : `<span class="char-err">${val[i]}</span>`;
        else h += `<span style="color:rgba(255,255,255,0.15)">${tgt[i]}</span>`;
    }
    document.getElementById('highlight-layer').innerHTML = h;
}

function finishSession() {
    state.phase = 'FINISH';
    document.getElementById('cmd-text').innerText = "СЕССИЯ ЗАВЕРШЕНА";
    document.getElementById('desc-text').innerText = `ОШИБОК: ${state.errors} | СРЕДНЯЯ СКОРОСТЬ: ${(state.totalTime/state.count || 0).toFixed(1)} сек`;
    document.getElementById('uplink-data').classList.add('hidden');
    document.getElementById('enter-hint').innerText = "ENTER - ПЕРЕЗАПУСК"; document.getElementById('enter-hint').classList.remove('hidden');
}

function updateHighlight() {
    if(state.phase !== 'INPUT') return;
    const val = input.value.toUpperCase(); const alts = state.activeTask.alts;
    const isValidStart = alts.some(a => a.startsWith(val));
    
    // Если подсветка ВЫКЛЮЧЕНА, мы просто рисуем прозрачный текст для сохранения позиции курсора
    if (!state.showHints) {
        document.getElementById('highlight-layer').innerHTML = `<span style="color:transparent">${val}</span>`;
        return;
    }

    if(isValidStart) { document.getElementById('highlight-layer').innerHTML = `<span style="color:transparent">${val}</span>`; }
    else {
        let best = 0; alts.forEach(a => { let m=0; for(let i=0;i<val.length;i++){if(val[i]===a[i])m++;else break;} if(m>best)best=m; });
        document.getElementById('highlight-layer').innerHTML = `<span style="color:transparent">${val.substring(0,best)}</span><span class="char-err">${val.substring(best)}</span>`;
    }
}

function handleTab() {
    const val = input.value.toUpperCase(); if (!val) return;
    const parts = val.split(" "); const lastPart = parts[parts.length - 1];
    let suggestions = (parts.length === 1) ? COMMANDS : (parts[0] === "LIST" ? ["A", "W", "U", "RE", "Y", "ID", "CELL", "ZONE_"] : [...QUEST_OBJS, ...RESOURCES]);
    const matches = suggestions.filter(s => s.startsWith(lastPart));
    if (matches.length === 1) { parts[parts.length - 1] = matches[0]; input.value = parts.join(" "); updateHighlight(); playSound(400, 'sine', 0.05, 0.1); }
}

const input = document.getElementById('input');
input.oninput = () => { input.value = input.value.toUpperCase(); updateHighlight(); playSound(600, 'sine', 0.02, 0.05); };
window.onkeydown = (e) => {
    if(state.phase === 'INPUT') {
        if(e.key === 'Tab') { e.preventDefault(); handleTab(); }
        if(e.key === 'Enter' && input.value) checkResult(input.value);
    } else if (['RESULT','FINISH','TIMEOUT'].includes(state.phase)) {
        if(e.key === 'Enter') state.phase === 'FINISH' ? location.reload() : nextTask();
    }
    input.focus();
};
</script>
</body>
</html>