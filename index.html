<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>GTFO TERMINAL TRAINER v1.2</title>
    <style>
        :root {
            --bg: #01080e; --main: #00e5ff; --text: #ffffff;
            --dim: #162e3a; --err: #ff4d4d; --check-color: #607d8b;
            --success: #00ff88;
            --font: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }
        body {
            margin: 0; background: var(--bg); color: var(--text);
            font-family: var(--font); height: 100vh; overflow: hidden;
            display: flex; align-items: center; justify-content: center;
        }
        #terminal {
            width: 950px; padding: 45px; border: 1px solid rgba(0, 229, 255, 0.2);
            background: linear-gradient(145deg, rgba(2, 15, 25, 0.98), rgba(1, 8, 14, 0.99));
            position: relative; border-radius: 28px;
            box-shadow: 0 20px 80px rgba(0, 0, 0, 0.8), 0 0 40px rgba(0, 229, 255, 0.05);
        }
        
        .ui-btn {
            position: absolute; top: 25px; font-size: 0.7rem; 
            cursor: pointer; border: 1px solid var(--dim); padding: 8px 18px; 
            color: #4a6a7a; border-radius: 40px; transition: 0.3s;
            font-weight: 800; text-transform: uppercase; letter-spacing: 1.5px;
            background: transparent;
        }
        #sound-btn { right: 35px; }
        #sound-btn.on { color: var(--main); border-color: var(--main); background: rgba(0, 229, 255, 0.05); }
        #exit-btn-top { left: 35px; color: #ff4d4d; border-color: rgba(255, 77, 77, 0.3); }
        #exit-btn-top:hover { background: rgba(255, 77, 77, 0.1); border-color: #ff4d4d; }

        .history-dots { display: flex; justify-content: center; gap: 10px; margin-bottom: 35px; }
        .rect { 
            width: 45px; height: 12px; 
            border: 1px solid var(--dim); 
            background: rgba(255,255,255,0.03); 
            transition: 0.4s; 
            border-radius: 2px;
        }

        .stats {
            display: flex; justify-content: space-between; align-items: center;
            padding-bottom: 15px; font-size: 0.85rem; color: var(--main);
            font-weight: 700; text-transform: uppercase; letter-spacing: 1px;
            border-bottom: 1px solid rgba(0, 229, 255, 0.1); margin-bottom: 20px;
        }

        .target-box {
            text-align: center; font-size: 1.9rem; letter-spacing: 1.5px;
            color: var(--text); margin-bottom: 25px; min-height: 2.2em;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-weight: 700;
        }
        .uplink-row { 
            font-size: 1.05rem; color: #7090a0; margin-top: 15px; font-weight: 600; 
            background: rgba(0,229,255,0.08); padding: 14px 28px; 
            border: 1px dashed var(--dim); border-radius: 16px; font-family: monospace;
        }

        .bar-info {
            display: flex; justify-content: space-between; align-items: flex-end;
            height: 1.8rem; margin-bottom: 5px; padding: 0 2px;
        }
        #status-msg { font-weight: 800; font-size: 1.2rem; text-transform: uppercase; letter-spacing: 2px; }
        #timer-display { font-family: monospace; font-size: 1.4rem; color: var(--main); font-weight: 700; }

        .timer-bg { width: 100%; height: 8px; background: rgba(0,0,0,0.5); margin-bottom: 10px; border-radius: 10px; overflow: hidden; }
        #timer-bar { height: 100%; width: 100%; background: var(--main); box-shadow: 0 0 20px rgba(0, 229, 255, 0.5); }
        
        #timer-bar.checking { background: var(--check-color); transition: width 0.8s linear; box-shadow: none; }
        #timer-bar.success { background: var(--success); box-shadow: 0 0 20px var(--success); }
        #timer-bar.error { background: var(--err); box-shadow: 0 0 20px var(--err); }

        .desc-box { min-height: 60px; margin-bottom: 25px; text-align: center; color: #a0c0d0; font-size: 1.15rem; font-weight: 500; }
        
        .input-line {
            position: relative; font-size: 2.3rem; display: flex; align-items: center;
            border-left: 6px solid var(--main); padding-left: 25px; 
            background: rgba(0,229,255,0.04); border-radius: 8px 20px 20px 8px;
        }
        #highlight-layer { position: absolute; left: 25px; top: 0; pointer-events: none; white-space: pre; color: transparent; z-index: 3; font-weight: 700; }
        .char-err { color: var(--err); text-decoration: underline; }

        #input {
            background: transparent; border: none; outline: none;
            color: var(--text); font-family: var(--font); font-size: 2.3rem;
            width: 100%; text-transform: uppercase; z-index: 2; font-weight: 700;
        }
        .main-title { font-size: 3rem; font-weight: 900; letter-spacing: -1px; color: var(--main); margin-bottom: 30px; text-align: center; text-transform: uppercase; }
        .menu-section { margin-bottom: 25px; text-align: center; }
        .menu-label { font-size: 0.75rem; color: #5a7a8a; letter-spacing: 4px; margin-bottom: 10px; font-weight: 800; text-transform: uppercase; }
        
        .opt-group { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }
        .opt { 
            padding: 10px 20px; cursor: pointer; border: 1px solid var(--dim); 
            color: #608090; font-weight: 700; font-size: 0.85rem; border-radius: 40px;
            transition: 0.3s; min-width: 100px; text-transform: uppercase;
        }
        .opt.active { border-color: var(--main); background: rgba(0, 229, 255, 0.1); color: var(--text); }
        .opt.special.active { border-color: #ff9800; color: #ff9800; background: rgba(255, 152, 0, 0.1); }
        .opt.danger.active { border-color: var(--err); color: var(--err); background: rgba(255, 77, 77, 0.1); }
        .opt.disabled { opacity: 0.3; pointer-events: none; filter: grayscale(1); cursor: not-allowed; }

        .start-btn { 
            margin-top: 10px; padding: 20px 100px; border: none; 
            cursor: pointer; font-weight: 900; letter-spacing: 5px; border-radius: 20px;
            background: var(--main); color: var(--bg); transition: 0.4s;
            text-transform: uppercase; font-size: 1.1rem;
        }
        .start-btn:hover { transform: scale(1.05); }
        
        .hidden { display: none !important; }
        .blink { animation: blinker 1.5s linear infinite; color: var(--main); font-weight: 800; }
        @keyframes blinker { 50% { opacity: 0.2; } }
    </style>
</head>
<body>

<div id="terminal">
    <div id="sound-btn" class="ui-btn on" onclick="toggleSound()">Звук: ВКЛ</div>
    <div id="exit-btn-top" class="ui-btn hidden" onclick="location.reload()">Выйти</div>

    <div id="m-screen">
        <div class="main-title">GTFO TERMINAL TRAINER v1.2</div>
        <div class="menu-section">
            <div class="menu-label">Количество билетов (по 10 вопросов)</div>
            <div class="opt-group">
                <div class="opt" onclick="setTickets(1, this)">1 билет</div>
                <div class="opt active" onclick="setTickets(2, this)">2 билета</div>
                <div class="opt" onclick="setTickets(3, this)">3 билета</div>
                <div class="opt" onclick="setTickets(4, this)">4 билета</div>
                <div class="opt" onclick="setTickets(5, this)">5 билетов</div>
            </div>
        </div>
        <div class="menu-section">
            <div class="menu-label">Сложность</div>
            <div class="opt-group" id="diff-group">
                <div class="opt" onclick="setDiff('EASY', this)">Легко</div>
                <div class="opt active" onclick="setDiff('NORM', this)">Нормально</div>
                <div class="opt" onclick="setDiff('HARD', this)">Сложно</div>
            </div>
        </div>
        <div class="menu-section">
            <div class="menu-label">Режим</div>
            <div class="opt-group">
                <div class="opt active" onclick="setMode('REG', this)">Обычный</div>
                <div class="opt" onclick="setMode('ZEN', this)">Без времени</div>
            </div>
        </div>
        <div class="menu-section">
            <div class="menu-label">Настройки помощи</div>
            <div class="opt-group">
                <div id="hint-toggle" class="opt active special" onclick="toggleHighlight(this)">Подсветка ошибок: ВКЛ</div>
            </div>
        </div>
        <div class="menu-section">
            <div class="menu-label">Экспертные функции</div>
            <div class="opt-group">
                <div id="hardcore-toggle" class="opt danger" onclick="toggleHardcore(this)">РЕЖИМ HARDCORE: ВЫКЛ</div>
            </div>
        </div>
        <div style="text-align:center"><button class="start-btn" onclick="gameStart()">НАЧАТЬ</button></div>
    </div>

    <div id="g-screen" class="hidden">
        <div class="history-dots" id="dots-panel"></div>
        <div class="stats">
            <div>БИЛЕТ: <span id="current-ticket-text">1</span> / <span id="total-tickets-text">1</span></div>
            <div>СРЕДНЯЯ СКОРОСТЬ: <span id="avg-time">0.0</span> сек</div>
        </div>
        <div id="target-cmd" class="target-box">
            <div id="cmd-text"></div>
            <div id="uplink-data" class="uplink-row hidden"></div>
        </div>
        <div class="bar-info">
            <div id="status-msg"></div> 
            <div id="timer-display"><span id="cur-timer">0.0</span></div>
        </div>
        <div class="timer-bg"><div id="timer-bar"></div></div>
        <div class="desc-box" id="desc-text"></div>
        <div class="input-line">
            <div id="highlight-layer"></div>
            <input type="text" id="input" autocomplete="off" spellcheck="false">
        </div>
        <div style="text-align:center; margin-top:20px; height:20px">
            <div id="enter-hint" class="blink hidden">НАЖМИТЕ [ENTER]</div>
        </div>
    </div>
</div>

<script>
let soundEnabled = true;
let audioCtx = null;

const WORDS = ["VOID", "CORE", "RISK", "DATA", "FLOW", "SYNC", "LINK", "GRID", "NODE", "BASE", "ZULU", "DARK", "BEAM", "CELL", "BONE", "DISK", "PLUG", "GATE", "ZONE", "FAST", "DEBT", "SOUL", "GRIT", "WOLF", "ZERO", "PATH", "MIND", "SCAN", "WORK", "HELL", "DUST", "ROCK", "SHIP", "SALT", "WIND", "GOLD", "IRON", "STAY", "KILL", "LIFE", "HOPE", "RARE", "DROP", "MIST", "COAL", "GEAR", "FUEL", "TANK", "PIPE", "WIRE", "BOLT", "JUMP", "LIFT", "STOP", "LOAD", "SAVE", "EXIT", "BLUE", "FIRE", "BOMB"];
const QUEST_OBJS = ["CELL", "TURBINE", "CARGO", "HSU", "NEONATE_HSU", "GENERATOR", "TERMINAL", "DISINFECT_STATION"];
const RESOURCES = ["AMMOPACK", "MEDIPACK", "TOOL_REFILL", "DISINFECT_PACK"];
const COMMANDS = ["LIST", "QUERY", "PING", "LOGS", "READ", "REACTOR_STARTUP", "REACTOR_SHUTDOWN", "REACTOR_VERIFY", "UPLINK_CONNECT", "UPLINK_VERIFY"];

const TIMERS = {
    EASY: { LIST:30, QUERY:30, PING:30, LOGS:10, READ:30, REACTOR_STARTUP:20, REACTOR_SHUTDOWN:20, REACTOR_VERIFY:30, UPLINK_CONNECT:30, UPLINK_VERIFY:40 },
    NORM: { LIST:15, QUERY:15, PING:15, LOGS:5,  READ:15, REACTOR_STARTUP:15, REACTOR_SHUTDOWN:15, REACTOR_VERIFY:20, UPLINK_CONNECT:20, UPLINK_VERIFY:25 },
    HARD: { LIST:10, QUERY:10, PING:10, LOGS:5,  READ:10, REACTOR_STARTUP:10, REACTOR_SHUTDOWN:10, REACTOR_VERIFY:10, UPLINK_CONNECT:10, UPLINK_VERIFY:15 }
};

const LIST_LABELS = { "A": "ВСЕ ОБЪЕКТЫ", "W": "КВЕСТОВЫЕ ОБЪЕКТЫ", "U": "КВЕСТОВЫЕ ОБЪЕКТЫ И РЕСУРСЫ", "RE": "РЕСУРСЫ", "Y": "КЛЮЧИ", "ID": "ID", "CELL": "БАТАРЕИ" };

let state = { 
    diff: 'NORM', mode: 'REG', tickets: 2, hardcore: false, showHints: true, 
    qIndex: 0, totalQ: 20, phase: 'MENU', totalTime: 0, count: 0, errors: 0, 
    history: [], masterQueue: [], activeTask: null, timer: null, startTime: 0,
    ticketErrors: 0, ticketTime: 0, ticketCount: 0
};

function playSound(f, t, d, v) {
    if (!soundEnabled) return;
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
    o.type = t; o.frequency.setValueAtTime(f, audioCtx.currentTime);
    g.gain.setValueAtTime(v, audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + d);
    o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime + d);
}

function toggleSound() {
    soundEnabled = !soundEnabled;
    document.getElementById('sound-btn').innerText = `Звук: ${soundEnabled ? 'ВКЛ' : 'ВЫКЛ'}`;
    document.getElementById('sound-btn').classList.toggle('on', soundEnabled);
}

function setTickets(n, el) { state.tickets = n; state.totalQ = n * 10; el.parentNode.querySelectorAll('.opt').forEach(b => b.classList.remove('active')); el.classList.add('active'); }
function setDiff(d, el) { if (state.mode === 'ZEN') return; state.diff = d; el.parentNode.querySelectorAll('.opt').forEach(b => b.classList.remove('active')); el.classList.add('active'); }
function setMode(m, el) { 
    state.mode = m; el.parentNode.querySelectorAll('.opt').forEach(b => b.classList.remove('active')); el.classList.add('active'); 
    const dOpts = document.querySelectorAll('#diff-group .opt');
    if (m === 'ZEN') dOpts.forEach(b => b.classList.add('disabled')); else dOpts.forEach(b => b.classList.remove('disabled'));
}

function toggleHardcore(el) { 
    state.hardcore = !state.hardcore; el.classList.toggle('active', state.hardcore); el.innerText = `РЕЖИМ HARDCORE: ${state.hardcore ? 'ВКЛ' : 'ВЫКЛ'}`; 
    const hBtn = document.getElementById('hint-toggle');
    if (state.hardcore) { state.showHints = false; hBtn.classList.remove('active'); hBtn.innerText = `Подсветка ошибок: ВЫКЛ`; hBtn.classList.add('disabled'); }
    else hBtn.classList.remove('disabled');
}

function toggleHighlight(el) { if (state.hardcore) return; state.showHints = !state.showHints; el.classList.toggle('active', state.showHints); el.innerText = `Подсветка ошибок: ${state.showHints ? 'ВКЛ' : 'ВЫКЛ'}`; }

function rand(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }
function genFileName() {
    const s = () => Math.random().toString(36).substring(2,5).toUpperCase();
    return Math.random() > 0.5 ? `${s()}-${s()}-${s()}` : `REACTOR_VER${["X","Y","Z"][rand(0,2)]}${rand(1,9).toString().padStart(2,'0')}.LOG`;
}

function prepareMasterQueue() {
    let pool = []; const types = [0,1,2,3,4,5,6,7,8,9,10,11,12,13,14];
    while (pool.length < state.totalQ) {
        let shuffle = [...types].sort(() => Math.random() - 0.5);
        if (pool.length > 0 && pool[pool.length - 1] === shuffle[0]) shuffle.push(shuffle.shift());
        pool = pool.concat(shuffle);
    }
    state.masterQueue = pool.slice(0, state.totalQ);
}

function generateTask(id) {
    let cmd = "", displayCmd = "", alts = [], desc = "", uplinkStr = "", tKey = "";
    const zNum = rand(1, 999); const zStr = `ZONE_${zNum}`;
    const word = WORDS[rand(0, WORDS.length-1)];
    const qObj = `${QUEST_OBJS[rand(0, QUEST_OBJS.length-1)]}_${rand(1, 999)}`;
    const rObj = `${RESOURCES[rand(0, RESOURCES.length-1)]}_${rand(1, 999)}`;
    const useZone = Math.random() > 0.5;

    switch(id) {
        case 0: case 4: case 6: case 7: case 8: case 9: 
            tKey = "LIST"; const fs = ["RE", "A", "Y", "W", "CELL", "ID", "U"];
            const f = fs[rand(0, fs.length - 1)]; const label = LIST_LABELS[f];
            cmd = useZone ? `LIST ${f} ${zStr}` : `LIST ${f}`;
            desc = useZone ? `Узнать ${label} в зоне ${zStr}` : `Узнать ${label} на уровне`;
            if (useZone) alts = [cmd, cmd.replace("ZONE_", "")]; displayCmd = cmd; break;
        case 1: 
            tKey="QUERY"; cmd=`QUERY ${qObj}`; desc=useZone?`УЗНАТЬ местоположение ${qObj} в ${zStr}`:`УЗНАТЬ местоположение ${qObj} на уровне`; 
            if(useZone) { cmd += ` ${zStr}`; alts = [cmd, cmd.replace("ZONE_", "")]; } displayCmd = cmd; break;
        case 2: tKey="PING"; const pObj = Math.random()>0.5?qObj:rObj; cmd=`PING ${pObj}`; desc=`ОТМЕТИТЬ местоположение ${pObj}`; if(Math.random() < 0.5) { cmd += " -T"; desc += " (повторять команду)"; } displayCmd = cmd; break;
        case 3: tKey="READ"; const fn = genFileName(); cmd=`READ ${fn}`; desc=`Прочитать файл ${fn}`; displayCmd = cmd; break;
        case 5: tKey="UPLINK_VERIFY"; 
                const tCode = ["X","Y","Z"][rand(0,2)]+rand(1,9).toString().padStart(2,'0'); 
                let pairs = []; for(let i=0;i<6;i++){ const c = (i===0)?tCode:["X","Y","Z"][rand(0,2)]+rand(1,9).toString().padStart(2,'0'); pairs.push(`${c}:${WORDS[rand(0,WORDS.length-1)]}`); }
                pairs.sort(()=>Math.random()-0.5); uplinkStr=pairs.join("   "); const corW=pairs.find(p=>p.startsWith(tCode)).split(":")[1];
                cmd=`UPLINK_VERIFY ${corW}`; desc=`Подтвердить СОЗДАНИЕ ПОДКЛЮЧЕНИЯ с кодом: ${tCode}`; 
                displayCmd = `UPLINK_VERIFY ${tCode}`; alts=[cmd]; break;
        case 10: tKey="REACTOR_VERIFY"; cmd=`REACTOR_VERIFY ${word}`; desc=`Подтвердить ЗАПУСК/ВЫКЛЮЧЕНИЕ РЕАКТОРА с кодом: ${word}`; displayCmd = cmd; break;
        case 11: tKey="UPLINK_CONNECT"; const ip=`${rand(10,255)}.${rand(0,255)}.${rand(0,255)}.${rand(1,254)}`; cmd=`UPLINK_CONNECT ${ip}`; desc=`Создать соединение с IP: ${ip}`; displayCmd = cmd; break;
        case 12: tKey="LOGS"; cmd=`LOGS`; desc=`Вывести логи терминала`; displayCmd = cmd; break;
        case 13: tKey="REACTOR_STARTUP"; cmd=`REACTOR_STARTUP`; desc=`Инициализация ЗАПУСКА реактора`; displayCmd = cmd; break;
        case 14: tKey="REACTOR_SHUTDOWN"; cmd=`REACTOR_SHUTDOWN`; desc=`Инициализация ВЫКЛЮЧЕНИЯ реактора`; displayCmd = cmd; break;
    }
    if(alts.length === 0) alts = [cmd];
    const fTime = state.hardcore ? TIMERS['HARD'][tKey] : TIMERS[state.diff][tKey];
    return { cmd, displayCmd, alts, desc, uplink: uplinkStr, time: fTime };
}

function updateUI() {
    let dTicketIdx = Math.floor(state.qIndex / 10);
    if (state.qIndex > 0 && state.qIndex % 10 === 0 && (state.phase !== 'INPUT' && state.phase !== 'TICKET_WAIT')) {
        dTicketIdx = Math.floor((state.qIndex - 1) / 10);
    }

    document.getElementById('current-ticket-text').innerText = Math.min(dTicketIdx + 1, state.tickets);
    document.getElementById('total-tickets-text').innerText = state.tickets;
    document.getElementById('avg-time').innerText = state.count > 0 ? (state.totalTime/state.count).toFixed(1) : "0.0";
    
    const panel = document.getElementById('dots-panel'); panel.innerHTML = '';
    for(let i=0; i<10; i++) {
        const rect = document.createElement('div'); rect.className = 'rect';
        const gIdx = (dTicketIdx * 10) + i;
        if(state.history[gIdx] !== undefined) {
            const isOk = state.history[gIdx];
            rect.style.backgroundColor = isOk ? 'var(--success)' : 'var(--err)';
            rect.style.boxShadow = `0 0 15px ${isOk ? 'var(--success)' : 'var(--err)'}`;
            rect.style.borderColor = isOk ? 'var(--success)' : 'var(--err)';
        }
        panel.appendChild(rect);
    }
}

function gameStart() {
    state.qIndex = 0; state.history = []; state.totalTime = 0; state.count = 0; state.errors = 0;
    prepareMasterQueue();
    document.getElementById('m-screen').classList.add('hidden');
    document.getElementById('g-screen').classList.remove('hidden');
    document.getElementById('exit-btn-top').classList.remove('hidden');
    updateUI(); nextTask();
}

function nextTask() {
    if (state.qIndex >= state.totalQ) { finishSession(); return; }
    if (state.qIndex % 10 === 0) { state.ticketErrors = 0; state.ticketTime = 0; state.ticketCount = 0; }
    state.phase = 'INPUT'; 
    state.activeTask = generateTask(state.masterQueue[state.qIndex]); 
    state.startTime = Date.now();
    document.getElementById('cmd-text').innerText = state.hardcore ? "[ЗАШИФРОВАНО]" : state.activeTask.displayCmd;
    document.getElementById('desc-text').innerText = state.activeTask.desc;
    const upBox = document.getElementById('uplink-data');
    if(state.activeTask.uplink) { upBox.innerText = state.activeTask.uplink; upBox.classList.remove('hidden'); } else upBox.classList.add('hidden');
    document.getElementById('status-msg').innerText = ""; document.getElementById('enter-hint').classList.add('hidden');
    document.getElementById('timer-bar').className = ''; document.getElementById('timer-bar').style.width = '100%';
    document.getElementById('input').value = ''; document.getElementById('input').disabled = false; document.getElementById('input').focus();
    document.getElementById('highlight-layer').innerHTML = '';
    if(state.mode !== 'ZEN') startTimer(state.activeTask.time); else document.getElementById('cur-timer').innerText = "---";
    updateUI();
}

function startTimer(sec) {
    clearInterval(state.timer); let cur = sec;
    state.timer = setInterval(() => {
        if(state.phase !== 'INPUT') return;
        cur -= 0.05; document.getElementById('cur-timer').innerText = Math.max(0, cur).toFixed(1);
        document.getElementById('timer-bar').style.width = (cur/sec*100) + '%';
        if(cur <= 0) { 
            clearInterval(state.timer); state.phase = 'TIMEOUT';
            document.getElementById('input').disabled = true;
            document.getElementById('status-msg').innerText = "ВРЕМЯ ВЫШЛО"; document.getElementById('status-msg').style.color = "var(--err)";
            document.getElementById('enter-hint').innerText = "ENTER - ПРОДОЛЖИТЬ"; document.getElementById('enter-hint').classList.remove('hidden');
            state.history.push(false); state.errors++; state.ticketErrors++; state.qIndex++; updateUI(); playSound(150, 'sawtooth', 0.4, 0.1);
        }
    }, 50);
}

function checkResult(val) {
    const sTime = (Date.now() - state.startTime) / 1000;
    state.phase = 'CHECKING'; clearInterval(state.timer);
    document.getElementById('input').disabled = true;
    const bar = document.getElementById('timer-bar'); const sBox = document.getElementById('status-msg');
    sBox.innerText = "ПРОВЕРКА..."; sBox.style.color = "var(--check-color)"; bar.style.width = '0%';
    setTimeout(() => {
        bar.className = 'checking'; bar.style.width = '100%';
        setTimeout(() => {
            state.phase = 'RESULT';
            const isOk = state.activeTask.alts.includes(val.trim().toUpperCase());
            if(isOk) {
                state.count++; state.totalTime += sTime; state.ticketCount++; state.ticketTime += sTime;
                state.history.push(true); sBox.innerText = "УСПЕХ"; sBox.style.color = "var(--success)"; bar.className = 'success'; playSound(880, 'sine', 0.1, 0.1);
            } else {
                state.errors++; state.ticketErrors++; state.history.push(false);
                sBox.innerText = "ОШИБКА"; sBox.style.color = "var(--err)"; bar.className = 'error'; playSound(150, 'sawtooth', 0.3, 0.1); showDiff(val);
            }
            state.qIndex++; updateUI(); 
            if (state.qIndex % 10 === 0 && state.qIndex < state.totalQ) {
                state.phase = 'TICKET_END'; document.getElementById('enter-hint').innerText = "ENTER - СТАТИСТИКА БИЛЕТА";
            } else if (state.qIndex >= state.totalQ) {
                state.phase = 'FINISH_PENDING'; document.getElementById('enter-hint').innerText = "ENTER - ЗАВЕРШИТЬ СЕССИЮ";
            } else {
                document.getElementById('enter-hint').innerText = "ENTER - СЛЕДУЮЩИЙ ВОПРОС";
            }
            document.getElementById('enter-hint').classList.remove('hidden');
        }, 800);
    }, 50);
}

function showTicketEnd() {
    const tNum = state.qIndex / 10;
    document.getElementById('cmd-text').innerText = `БИЛЕТ №${tNum} ЗАВЕРШЕН`;
    const aT = state.ticketCount > 0 ? (state.ticketTime / state.ticketCount).toFixed(1) : "0.0";
    document.getElementById('desc-text').innerText = `ОШИБОК: ${state.ticketErrors} | СКОРОСТЬ: ${aT} сек`;
    document.getElementById('status-msg').innerText = "ПАУЗА"; document.getElementById('status-msg').style.color = "var(--main)";
    document.getElementById('uplink-data').classList.add('hidden');
    document.getElementById('enter-hint').innerText = "ENTER - СЛЕДУЮЩИЙ БИЛЕТ";
}

function finishSession() {
    state.phase = 'FINISH';
    document.getElementById('cmd-text').innerText = "СЕССИЯ ЗАВЕРШЕНА";
    const tA = state.count > 0 ? (state.totalTime / state.count).toFixed(1) : "0.0";
    document.getElementById('desc-text').innerText = `ИТОГО ОШИБОК: ${state.errors} | СРЕДНЯЯ СКОРОСТЬ: ${tA} сек`;
    document.getElementById('status-msg').innerText = "КОНЕЦ";
    document.getElementById('enter-hint').innerText = "ENTER - В МЕНЮ";
}

function updateHighlight() {
    if(state.phase !== 'INPUT') return;
    const v = input.value.toUpperCase(); const alts = state.activeTask.alts;
    if (!state.showHints) { document.getElementById('highlight-layer').innerHTML = `<span style="color:transparent">${v}</span>`; return; }
    if(alts.some(a => a.startsWith(v))) document.getElementById('highlight-layer').innerHTML = `<span style="color:transparent">${v}</span>`;
    else {
        let b = 0; alts.forEach(a => { let m=0; for(let i=0;i<v.length;i++){if(v[i]===a[i])m++;else break;} if(m>b)b=m; });
        document.getElementById('highlight-layer').innerHTML = `<span style="color:transparent">${v.substring(0,b)}</span><span class="char-err">${v.substring(b)}</span>`;
    }
}

function handleTab() {
    const v = input.value.toUpperCase(); const ps = v.split(" "); const lp = ps[ps.length - 1];
    if (!lp && v.length > 0) return;
    let suggestions = [];
    if (ps.length === 1) {
        suggestions = COMMANDS;
    } else {
        const cmd = ps[0];
        if (cmd === "LIST") suggestions = ["A", "W", "U", "RE", "Y", "ID", "CELL", "ZONE_"];
        else if (["QUERY", "PING"].includes(cmd)) suggestions = [...QUEST_OBJS, ...RESOURCES].map(s => s + "_");
    }
    const matches = suggestions.filter(s => s.startsWith(lp));
    if (matches.length > 0) {
        let lcp = matches[0];
        if (matches.length > 1) {
            for (let i = 1; i < matches.length; i++) {
                let j = 0; while (j < lcp.length && j < matches[i].length && lcp[j] === matches[i][j]) j++;
                lcp = lcp.substring(0, j);
            }
        }
        if (lcp.length > lp.length) {
            ps[ps.length - 1] = lcp;
            input.value = ps.join(" ");
            updateHighlight(); playSound(400, 'sine', 0.05, 0.1);
        }
    }
}

function showDiff(val) {
    const t = state.activeTask.alts[0]; let h = "";
    for(let i=0; i<Math.max(t.length, val.length); i++) {
        if(i < val.length) h += (i < t.length && val[i].toUpperCase() === t[i]) ? `<span style="color:transparent">${val[i]}</span>` : `<span class="char-err">${val[i]}</span>`;
        else h += `<span style="color:rgba(255,255,255,0.15)">${t[i]}</span>`;
    }
    document.getElementById('highlight-layer').innerHTML = h;
}

const input = document.getElementById('input');
input.oninput = () => { input.value = input.value.toUpperCase(); updateHighlight(); playSound(600, 'sine', 0.02, 0.05); };
window.onkeydown = (e) => {
    if(state.phase === 'INPUT') {
        if(e.key === 'Tab') { e.preventDefault(); handleTab(); }
        if(e.key === 'Enter' && input.value) checkResult(input.value);
    } else if (state.phase === 'RESULT' || state.phase === 'TIMEOUT') {
        if(e.key === 'Enter') nextTask();
    } else if (state.phase === 'TICKET_END') {
        if(e.key === 'Enter') { showTicketEnd(); state.phase = 'TICKET_WAIT'; }
    } else if (state.phase === 'TICKET_WAIT') {
        if(e.key === 'Enter') nextTask();
    } else if (state.phase === 'FINISH_PENDING') {
        if(e.key === 'Enter') finishSession();
    } else if (state.phase === 'FINISH') {
        if(e.key === 'Enter') location.reload();
    }
    input.focus();
};
</script>
</body>
</html>
